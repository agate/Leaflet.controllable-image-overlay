/*
 * Leaflet.controllable-image-overlay v0.2.0
 * 
 * A plugin to Leaflet powered maps that:
 * 1. allow you to put an image above the map.
 * 2. allow you to rotate, resize, move and set opacity of this image.
 * 
 * Copyright (c) 2014 agate.
 * Licensed under the ISC license.
 * 
 * https://github.com/agate/Leaflet.controllable-image-overlay
 * 
 * Date: Fri, 15 Aug 2014 03:24:20 GMT
 */

(function(){L.Control.ControllableImageOverlay=L.Control.extend({options:{position:"topleft",modes:["image","rotate","scale","move","transparent"]},initialize:function(a){return L.Control.prototype.initialize.call(this,a),this._overlay=L.controllableImageOverlay(this)},onAdd:function(a){var b,c;return b="leaflet-controllable-image-overlay",this._container=L.DomUtil.create("div",b+" leaflet-bar"),this._map=a,this._imageButton=this._createButton("C","Change image",b+"-image",this._container,this._changeImage,this),this._rotateButton=this._createButton("R","Rotate image",b+"-rotate",this._container,this._enableRotate,this),this._scaleButton=this._createButton("S","Resize image",b+"-scale",this._container,this._enableScale,this),this._moveButton=this._createButton("M","Move image",b+"-move",this._container,this._enableMove,this),this._transparentButton=this._createButton("T","Transparent image",b+"-transparent",this._container,this._enableTransparent,this),this._imageForm=L.DomUtil.create("ul",b+"-actions",this._container),c=L.DomUtil.create("li","",this._imageForm),this._imageUrl=L.DomUtil.create("input","",c),this._imageUrl.placeholder="Fill your image url in here",this._initElementEvents(this._imageUrl),L.DomUtil.addClass(this._rotateButton,"leaflet-disabled"),L.DomUtil.addClass(this._scaleButton,"leaflet-disabled"),L.DomUtil.addClass(this._moveButton,"leaflet-disabled"),L.DomUtil.addClass(this._transparentButton,"leaflet-disabled"),this._overlay.addTo(a),this._container},onRemove:function(){},onImageChanged:function(){return L.DomUtil.removeClass(this._rotateButton,"leaflet-disabled"),L.DomUtil.removeClass(this._scaleButton,"leaflet-disabled"),L.DomUtil.removeClass(this._moveButton,"leaflet-disabled"),L.DomUtil.removeClass(this._transparentButton,"leaflet-disabled")},_changeImage:function(){var a;if(!this._isDisabled(this._imageButton))return this._changeImageEnabled?(this._changeImageEnabled=!1,L.DomUtil.removeClass(this._container,"actions-shown"),a=this._imageUrl.value.trim(),a.length>0&&a!==this.options.image&&(this.options.image=a,this._map.fire("image:changed")),this.options.image?this._exitMode("image"):void 0):(this._changeImageEnabled=!0,this._enterMode("image"),L.DomUtil.addClass(this._container,"actions-shown"))},_enableRotate:function(){return this._isDisabled(this._rotateButton)?void 0:this._imageRotateEnabled?(this._imageRotateEnabled=!1,this._exitMode("rotate"),this._map.fire("image:rotate:disabled")):(this._imageRotateEnabled=!0,this._enterMode("rotate"),this._map.fire("image:rotate:enabled"))},_enableScale:function(){return this._isDisabled(this._scaleButton)?void 0:this._imageScaleEnabled?(this._imageScaleEnabled=!1,this._exitMode("scale"),this._map.fire("image:scale:disabled")):(this._imageScaleEnabled=!0,this._enterMode("scale"),this._map.fire("image:scale:enabled"))},_enableMove:function(){return this._isDisabled(this._moveButton)?void 0:this._imageMoveEnabled?(this._imageMoveEnabled=!1,this._exitMode("move"),this._map.fire("image:move:disabled")):(this._imageMoveEnabled=!0,this._enterMode("move"),this._map.fire("image:move:enabled"))},_enableTransparent:function(){return this._isDisabled(this._transparentButton)?void 0:this._imageTransparentEnabled?(this._imageTransparentEnabled=!1,this._exitMode("transparent"),this._map.fire("image:transparent:disabled")):(this._imageTransparentEnabled=!0,this._enterMode("transparent"),this._map.fire("image:transparent:enabled"))},_createButton:function(a,b,c,d,e,f){var g;return g=L.DomUtil.create("a",c,d),g.innerHTML=a,g.href="#",g.title=b,this._initElementEvents(g),L.DomEvent.on(g,"click",e,f).on(g,"click",this._refocusOnMap,f),g},_initElementEvents:function(a){return L.DomEvent.on(a,"click",L.DomEvent.stopPropagation).on(a,"mousedown",L.DomEvent.stopPropagation).on(a,"dblclick",L.DomEvent.stopPropagation).on(a,"click",L.DomEvent.preventDefault)},_enterMode:function(a){return this.options.modes.forEach(function(b){var c;return c=this["_"+b+"Button"],a===b?L.DomUtil.removeClass(c,"leaflet-disabled"):L.DomUtil.addClass(c,"leaflet-disabled")},this)},_exitMode:function(){return this.options.modes.forEach(function(a){var b;return b=this["_"+a+"Button"],L.DomUtil.removeClass(b,"leaflet-disabled")},this)},_isDisabled:function(a){return a.className.indexOf("leaflet-disabled")>-1},disable:function(){return this.options.modes.forEach(function(a){var b;return b=this["_"+a+"Button"],L.DomUtil.addClass(b,"leaflet-disabled")})},enable:function(){return this.options.modes.forEach(function(a){var b;return b=this["_"+a+"Button"],L.DomUtil.removeClass(b,"leaflet-disabled")})}}),L.control.controllableImageOverlay=function(a){return new L.Control.ControllableImageOverlay(a)}}).call(this),function(){L.ControllableImageOverlay=L.Class.extend({includes:L.Mixin.Events,options:{opacity:1,imageRotate:0,imageOpacity:1,imageScale:1},initialize:function(a){return this._control=a},onAdd:function(a){return this._map=a,a.on("image:changed",this._eventImageChanged,this)},_eventImageChanged:function(){return this.options.imageRotate=0,this.options.imageOpacity=1,this.options.imageScale=1,this.options.image=this._control.options.image,this._initImage()},_onImageAdded:function(){var a;return a=this._map,a._panes.overlayPane.appendChild(this._image),a.on("viewreset",this._reset,this),a.options.zoomAnimation&&L.Browser.any3d&&a.on("zoomanim",this._animateZoom,this),a.on("image:rotate:enabled",function(){return L.DomEvent.on(this._image,"mousedown",this._rotateStart,this),L.DomEvent.on(this._image,"mousemove",this._rotating,this),L.DomEvent.on(this._image,"mouseout",this._rotateEnd,this),L.DomEvent.on(this._image,"mouseup",this._rotateEnd,this)},this),a.on("image:rotate:disabled",function(){return L.DomEvent.off(this._image,"mousedown",this._rotateStart,this),L.DomEvent.off(this._image,"mousemove",this._rotating,this),L.DomEvent.off(this._image,"mouseout",this._rotateEnd,this),L.DomEvent.off(this._image,"mouseup",this._rotateEnd,this)},this),a.on("image:scale:enabled",function(){return L.DomEvent.on(this._image,"mousedown",this._scaleStart,this),L.DomEvent.on(this._image,"mousemove",this._scaling,this),L.DomEvent.on(this._image,"mouseout",this._scaleEnd,this),L.DomEvent.on(this._image,"mouseup",this._scaleEnd,this)},this),a.on("image:scale:disabled",function(){return L.DomEvent.off(this._image,"mousedown",this._scaleStart,this),L.DomEvent.off(this._image,"mousemove",this._scaling,this),L.DomEvent.off(this._image,"mouseout",this._scaleEnd,this),L.DomEvent.off(this._image,"mouseup",this._scaleEnd,this)},this),a.on("image:move:enabled",function(){return L.DomEvent.on(this._image,"mousedown",this._moveStart,this),L.DomEvent.on(this._image,"mousemove",this._moving,this),L.DomEvent.on(this._image,"mouseout",this._moveEnd,this),L.DomEvent.on(this._image,"mouseup",this._moveEnd,this)},this),a.on("image:move:disabled",function(){return L.DomEvent.off(this._image,"mousedown",this._moveStart,this),L.DomEvent.off(this._image,"mousemove",this._moving,this),L.DomEvent.off(this._image,"mouseout",this._moveEnd,this),L.DomEvent.off(this._image,"mouseup",this._moveEnd,this)},this),a.on("image:transparent:enabled",function(){return L.DomEvent.on(this._image,"mousewheel",this._transparent,this)},this),a.on("image:transparent:disabled",function(){return L.DomEvent.off(this._image,"mousewheel",this._transparent,this)},this),this._reset()},_rotateStart:function(a){return L.DomEvent.stopPropagation(a),this._imageRotating=!0,this._imageRotateDiff=this._getMouseImageRotate(a)-this.options.imageRotate},_rotateEnd:function(a){return L.DomEvent.stopPropagation(a),this._imageRotating=!1},_rotating:function(a){return this._imageRotating?(L.DomEvent.stopPropagation(a),this.options.imageRotate=this._getMouseImageRotate(a)-this._imageRotateDiff,this._reset()):void 0},_getMouseImageRotate:function(a){var b,c,d,e,f;return e=this._image.getBoundingClientRect(),b=e.left+e.width/2,c=e.top+e.height/2,f=Math.atan2(a.pageX-b,a.pageY-c),d=f*(180/Math.PI)*-1+90},_scaleStart:function(a){return L.DomEvent.stopPropagation(a),this._imageScaling=!0,this._imageScalingInitScale=this.options.imageScale,this._imageScalingInitPoint={x:a.pageX,y:a.pageY}},_scaleEnd:function(a){return L.DomEvent.stopPropagation(a),this._imageScaling=!1},_scaling:function(a){var b,c,d,e,f,g,h,i,j,k;if(this._imageScaling)return L.DomEvent.stopPropagation(a),j=this._image.getBoundingClientRect(),b=j.left+j.width/2,c=j.top+j.height/2,f=b-a.pageX,g=c-a.pageY,d=b-this._imageScalingInitPoint.x,e=c-this._imageScalingInitPoint.y,i=Math.sqrt(Math.pow(f,2)+Math.pow(g,2)),h=Math.sqrt(Math.pow(d,2)+Math.pow(e,2)),k=i/h*this._imageScalingInitScale,this.options.imageScale=k,this._reset()},_moveStart:function(a){return L.DomEvent.stopPropagation(a),this._imageMoving=!0},_moveEnd:function(a){return L.DomEvent.stopPropagation(a),this._imageMoving=!1},_moving:function(a){var b,c;if(this._imageMoving)return L.DomEvent.stopPropagation(a),b=this._map.latLngToLayerPoint(this._bounds.getNorthEast()),c=this._map.latLngToLayerPoint(this._bounds.getSouthWest()),b.x+=a.movementX,b.y+=a.movementY,c.x+=a.movementX,c.y+=a.movementY,this._bounds=L.latLngBounds(this._map.layerPointToLatLng(c),this._map.layerPointToLatLng(b)),this._reset()},_transparent:function(a){return L.DomEvent.stopPropagation(a),this.options.imageOpacity=this.options.imageOpacity+a.wheelDelta/120/50,this.options.imageOpacity>1&&(this.options.imageOpacity=1),this.options.imageOpacity<.2&&(this.options.imageOpacity=.2),this._reset()},onRemove:function(a){return a.getPanes().overlayPane.removeChild(this._image),a.off("viewreset",this._reset,this),a.options.zoomAnimation?a.off("zoomanim",this._animateZoom,this):void 0},addTo:function(a){return a.addLayer(this),this},setOpacity:function(a){return this.options.opacity=a,this._updateOpacity(),this},bringToFront:function(){return this._image&&this._map._panes.overlayPane.appendChild(this._image),this},bringToBack:function(){var a;return a=this._map._panes.overlayPane,this._image&&a.insertBefore(this._image,a.firstChild),this},setUrl:function(a){return this.options.image=a,this._image.src=a},getAttribution:function(){return this.options.attribution},_initImage:function(){return this.options.image?this._image?this._image.src=this.options.image:(this._image=L.DomUtil.create("img","leaflet-controllable-image-layer"),this._map.options.zoomAnimation&&L.Browser.any3d?L.DomUtil.addClass(this._image,"leaflet-zoom-animated"):L.DomUtil.addClass(this._image,"leaflet-zoom-hide"),this._updateOpacity(),L.extend(this._image,{galleryimg:"no",onselectstart:L.Util.falseFn,onmousemove:L.Util.falseFn,onload:L.bind(this._onImageLoad,this),src:this.options.image}),this._onImageAdded()):void 0},_animateZoom:function(a){var b,c,d,e,f,g,h,i;return c=this._map,b=this._image,f=c.getZoomScale(a.zoom),d=this._bounds.getNorthWest(),g=this._bounds.getSouthEast(),i=c._latLngToNewLayerPoint(d,a.zoom,a.center),h=c._latLngToNewLayerPoint(g,a.zoom,a.center)._subtract(i),e=i._add(h._multiplyBy(.5*(1-1/f))),b.style[L.DomUtil.TRANSFORM]=L.DomUtil.getTranslateString(e)+" scale("+f*this.imageScale+") rotate("+this.options.imageRotate+")"},_reset:function(){var a,b,c;if(this._imageLoaded)return a=this._image,c=this._map.latLngToLayerPoint(this._bounds.getNorthWest()),b=this._map.latLngToLayerPoint(this._bounds.getSouthEast())._subtract(c),L.DomUtil.setPosition(a,c),L.DomUtil.setOpacity(a,this.options.imageOpacity),a.style.width=b.x+"px",a.style.height=b.y+"px",a.style[L.DomUtil.TRANSFORM]+=" scale("+this.options.imageScale+")",a.style[L.DomUtil.TRANSFORM]+=" rotate("+this.options.imageRotate+"deg)"},_onImageLoad:function(){var a,b;return b=this,a=this._map,this.fire("load"),this._getImageInfo(this.options.image,function(c){var d,e,f,g,h,i,j,k,l,m,n;return b._imageLoaded=!0,e=a.getBounds(),k=a.latLngToContainerPoint(e.getNorthEast()),l=a.latLngToContainerPoint(e.getSouthWest()),n=k.x-l.x,j=l.y-k.y,f=n/2,g=j/2,c.width>c.height?(h=f/c.width*c.height,m=a.containerPointToLatLng(L.point(.75*n,g-h/2)),d=a.containerPointToLatLng(L.point(.25*n,g+h/2))):(i=g/c.height*c.width/2,m=a.containerPointToLatLng(L.point(f+i/2,.25*j)),d=a.containerPointToLatLng(L.point(f-i/2,.75*j))),b._bounds=L.latLngBounds([d,m]),b._reset()})},_getImageInfo:function(a,b){var c;return c=new Image,c.src=a,c.onload=function(){return b({width:c.width,height:c.height})}},_updateOpacity:function(){return L.DomUtil.setOpacity(this._image,this.options.opacity)}}),L.controllableImageOverlay=function(a,b,c){return new L.ControllableImageOverlay(a,b,c)}}.call(this);